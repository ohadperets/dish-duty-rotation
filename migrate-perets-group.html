<!DOCTYPE html>
<html>
<head>
    <title>Migrate Perets Group to 10000</title>
</head>
<body>
    <h1>Migrate Perets Group</h1>
    <p>This will create group 10000 for the Perets family with existing data and photos.</p>
    
    <button id="migrate-btn" style="padding: 1rem 2rem; font-size: 1.2rem; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 8px;">Migrate Now</button>
    <div id="status"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAQEEhofjHe66sMG3UbpsJ9JbCqoV7iALg",
            authDomain: "dishdutyrotation.firebaseapp.com",
            projectId: "dishdutyrotation",
            storageBucket: "dishdutyrotation.firebasestorage.app",
            messagingSenderId: "880812554578",
            appId: "1:880812554578:web:4a8f9d01e69fbb0b46228b",
            measurementId: "G-2KSKS4F7D1"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Helper function to upload image to ImgBB
        async function uploadToImgBB(imageUrl, apiKey) {
            try {
                // Use CORS proxy to fetch image
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(imageUrl);
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                
                // Convert to base64
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        try {
                            const base64Data = reader.result.split(',')[1]; // Remove data:image/png;base64, prefix
                            
                            // Upload to ImgBB
                            const formData = new FormData();
                            formData.append('image', base64Data);
                            
                            const uploadResponse = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (!uploadResponse.ok) {
                                throw new Error(`ImgBB upload failed: ${uploadResponse.statusText}`);
                            }
                            
                            const result = await uploadResponse.json();
                            if (result.success) {
                                resolve(result.data.url);
                            } else {
                                reject(new Error('ImgBB upload failed'));
                            }
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (err) {
                throw new Error(`Failed to fetch image: ${err.message}`);
            }
        }
        
        document.getElementById('migrate-btn').addEventListener('click', async () => {
            const status = document.getElementById('status');
            status.innerHTML = '<p>Starting migration...</p>';

            
            try {
                // Get existing dishData from production
                const oldDataRef = doc(db, 'dishData', 'production');
                const oldDataSnap = await getDoc(oldDataRef);
                
                const history = oldDataSnap.exists() ? oldDataSnap.data().history || [] : [];
                
                status.innerHTML += '<p>✓ Loaded existing history</p>';
                
                // Create group 10000
                const groupRef = doc(db, 'groups', '10000');
                await setDoc(groupRef, {
                    groupId: '10000',
                    name: 'Perets Family',
                    creatorUid: 'SYSTEM', // Replace with actual creator UID after first login
                    createdAt: serverTimestamp()
                });
                
                status.innerHTML += '<p>✓ Created group 10000</p>';
                
                // Use pre-uploaded ImgBB images
                status.innerHTML += '<p>Using pre-uploaded images from ImgBB...</p>';
                
                const dishwashers = {
                    'Yonatan': 'https://i.ibb.co/HJsy1vS/Yonatan.png',
                    'Ohad': 'https://i.ibb.co/N2R7QgQG/Ohad.png',
                    'Raz': 'https://i.ibb.co/TBkq4SMT/Raz.png',
                    'Yuval': 'https://i.ibb.co/XZcbXtVY/Yuval.png'
                };
                
                status.innerHTML += '<p>✓ Using images for all brothers</p>';

                
                const groupDataRef = doc(db, 'groupData', '10000');
                await setDoc(groupDataRef, {
                    dishwashers,
                    history,
                    lastUpdated: serverTimestamp()
                });
                
                status.innerHTML += '<p>✓ Migrated dishwashers and history</p>';
                status.innerHTML += '<p style="color: green; font-weight: bold;">✓✓✓ Migration complete!</p>';
                status.innerHTML += '<p>Group ID: 10000</p>';
                status.innerHTML += '<p>You can now search for group 10000 in the app!</p>';
                
            } catch (error) {
                console.error('Migration error:', error);
                status.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
