<!DOCTYPE html>
<html>
<head>
    <title>Migrate Perets Group to 10000</title>
</head>
<body>
    <h1>Migrate Perets Group</h1>
    <p><strong>Note:</strong> Due to CORS restrictions, automated migration is blocked. Please use the app to create group 10000 manually and add the dishwashers.</p>
    <p>Alternatively, test the multi-group feature by creating a new group from your phone!</p>
    
    <div style="margin-bottom: 1rem;">
        <label>ImgBB API Key: </label>
        <input type="text" id="imgbb-api-key" value="6e996b4be8ce9bbce89c6441155718ab" style="width: 300px; padding: 0.5rem;" />
        <p style="font-size: 0.9rem; color: #666;">Get your free API key at <a href="https://api.imgbb.com/" target="_blank">https://api.imgbb.com/</a></p>
    </div>
    
    <button id="migrate-btn" style="padding: 1rem 2rem; font-size: 1.2rem; cursor: pointer;" disabled>Migrate Now (Blocked by CORS)</button>
    <div id="status"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAQEEhofjHe66sMG3UbpsJ9JbCqoV7iALg",
            authDomain: "dishdutyrotation.firebaseapp.com",
            projectId: "dishdutyrotation",
            storageBucket: "dishdutyrotation.firebasestorage.app",
            messagingSenderId: "880812554578",
            appId: "1:880812554578:web:4a8f9d01e69fbb0b46228b",
            measurementId: "G-2KSKS4F7D1"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Helper function to upload image to ImgBB
        async function uploadToImgBB(imageUrl, apiKey) {
            try {
                // Use CORS proxy to fetch image
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(imageUrl);
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                
                // Convert to base64
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        try {
                            const base64Data = reader.result.split(',')[1]; // Remove data:image/png;base64, prefix
                            
                            // Upload to ImgBB
                            const formData = new FormData();
                            formData.append('image', base64Data);
                            
                            const uploadResponse = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (!uploadResponse.ok) {
                                throw new Error(`ImgBB upload failed: ${uploadResponse.statusText}`);
                            }
                            
                            const result = await uploadResponse.json();
                            if (result.success) {
                                resolve(result.data.url);
                            } else {
                                reject(new Error('ImgBB upload failed'));
                            }
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (err) {
                throw new Error(`Failed to fetch image: ${err.message}`);
            }
        }
        
        document.getElementById('migrate-btn').addEventListener('click', async () => {
            const status = document.getElementById('status');
            const apiKey = document.getElementById('imgbb-api-key').value.trim();
            
            if (!apiKey) {
                status.innerHTML = '<p style="color: red;">Please enter your ImgBB API key</p>';
                return;
            }
            
            status.innerHTML = '<p>Starting migration...</p>';

            
            try {
                // Get existing dishData from production
                const oldDataRef = doc(db, 'dishData', 'production');
                const oldDataSnap = await getDoc(oldDataRef);
                
                const history = oldDataSnap.exists() ? oldDataSnap.data().history || [] : [];
                
                status.innerHTML += '<p>‚úì Loaded existing history</p>';
                
                // Create group 10000
                const groupRef = doc(db, 'groups', '10000');
                await setDoc(groupRef, {
                    groupId: '10000',
                    name: 'Perets Family',
                    creatorUid: 'SYSTEM', // Replace with actual creator UID after first login
                    createdAt: serverTimestamp()
                });
                
                status.innerHTML += '<p>‚úì Created group 10000</p>';
                
                // Upload images to ImgBB and get URLs
                status.innerHTML += '<p>Uploading images to ImgBB...</p>';
                
                const brothers = ['Yonatan', 'Ohad', 'Raz', 'Yuval'];
                const dishwashers = {};
                
                for (const brother of brothers) {
                    try {
                        const imageUrl = `https://dishess.com/Images/${brother}.png`;
                        const downloadUrl = await uploadToImgBB(imageUrl, apiKey);
                        dishwashers[brother] = downloadUrl;
                        status.innerHTML += `<p>‚úì Uploaded ${brother}'s photo</p>`;
                    } catch (err) {
                        console.error(`Error uploading ${brother}:`, err);
                        status.innerHTML += `<p>‚ö† Failed to upload ${brother}'s photo: ${err.message}</p>`;
                        // Fallback to emoji if image upload fails
                        const emojis = { 'Yonatan': 'üë®‚Äçüíº', 'Ohad': 'üë®‚Äçüíª', 'Raz': 'üë®‚Äçüéì', 'Yuval': 'üë®‚Äçüî¨' };
                        dishwashers[brother] = emojis[brother];
                    }
                }

                
                const groupDataRef = doc(db, 'groupData', '10000');
                await setDoc(groupDataRef, {
                    dishwashers,
                    history,
                    lastUpdated: serverTimestamp()
                });
                
                status.innerHTML += '<p>‚úì Migrated dishwashers and history</p>';
                status.innerHTML += '<p style="color: green; font-weight: bold;">‚úì‚úì‚úì Migration complete!</p>';
                status.innerHTML += '<p>Group ID: 10000</p>';
                status.innerHTML += '<p>You can now search for group 10000 in the app!</p>';
                
            } catch (error) {
                console.error('Migration error:', error);
                status.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
